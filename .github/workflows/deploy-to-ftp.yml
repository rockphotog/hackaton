# Deploy Implementation Guide til FTP/SFTP server
# StÃ¸tter FTP, FTPS og SFTP med fleksibel konfigurasjon
# 
# VIKTIG: Denne workflowen kjÃ¸rer KUN manuelt - ikke automatisk
# Dette gir deg full kontroll over nÃ¥r og hvordan du publiserer til din egen server

name: Deploy to FTP/SFTP Server

on:
  workflow_dispatch:
    inputs:
      deploy_method:
        description: 'Deployment method'
        required: true
        default: 'ftp'
        type: choice
        options:
        - ftp
        - sftp
        - rsync-ssh
      target_directory:
        description: 'Remote target directory (optional override)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - show what would be deployed without actually deploying'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Show workflow inputs
      run: |
        echo "ðŸš€ FTP/SFTP Deployment Workflow"
        echo "================================"
        echo "Deploy method: ${{ github.event.inputs.deploy_method || 'ftp' }}"
        echo "Target directory: ${{ github.event.inputs.target_directory || 'default' }}"
        echo "Dry run: ${{ github.event.inputs.dry_run || 'false' }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        fetch-depth: 1

    - name: Verify gh-pages content
      run: |
        echo "ðŸ“‚ Checking gh-pages content..."
        ls -la
        if [ ! -f "index.html" ]; then
          echo "âš ï¸  Warning: No index.html found. Make sure IG has been built and published to gh-pages branch."
        else
          echo "âœ… Found IG content to deploy"
        fi

    - name: Install deployment tools
      run: |
        echo "ðŸ› ï¸  Installing deployment tools..."
        sudo apt-get update
        sudo apt-get install -y lftp rsync openssh-client
        echo "âœ… Tools installed successfully"

    - name: Validate required secrets
      env:
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "ðŸ” Validating secrets..."
        if [ -z "$FTP_SERVER" ]; then
          echo "âŒ FTP_SERVER secret is required"
          exit 1
        fi
        if [ -z "$FTP_USERNAME" ]; then
          echo "âŒ FTP_USERNAME secret is required"
          exit 1
        fi
        # Check authentication method
        if [ -z "$FTP_PASSWORD" ] && [ -z "$SSH_PRIVATE_KEY" ]; then
          echo "âŒ Either FTP_PASSWORD or SSH_PRIVATE_KEY secret is required"
          exit 1
        fi
        echo "âœ… Required secrets are configured"

    - name: Setup SSH key (for SFTP/SSH)
      if: ${{ github.event.inputs.deploy_method == 'sftp' || github.event.inputs.deploy_method == 'rsync-ssh' }}
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
      run: |
        echo "ðŸ”‘ Setting up SSH key for secure connection..."
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $FTP_SERVER >> ~/.ssh/known_hosts
        echo "âœ… SSH key configured"

    - name: Deploy via FTP/FTPS
      if: ${{ github.event.inputs.deploy_method == 'ftp' || github.event.inputs.deploy_method == '' }}
      env:
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        REMOTE_DIR: ${{ github.event.inputs.target_directory || secrets.FTP_REMOTE_DIR || '/public_html' }}
        FTP_PORT: ${{ secrets.FTP_PORT || '21' }}
        USE_SSL: ${{ secrets.FTP_USE_SSL || 'false' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "ðŸš€ Deploying via FTP/FTPS"
        echo "ðŸ“¡ Server: $FTP_SERVER:$FTP_PORT"
        echo "ï¿½ User: $FTP_USERNAME" 
        echo "ï¿½ðŸ“ Target: $REMOTE_DIR"
        echo "ðŸ” SSL: $USE_SSL"
        echo "ðŸ§ª Dry run: $DRY_RUN"
        echo ""
        
        # Build lftp command with better error handling
        LFTP_CMD="set ftp:ssl-allow $USE_SSL; set ftp:ssl-protect-data $USE_SSL; set net:timeout 30;"
        LFTP_CMD="$LFTP_CMD open -p $FTP_PORT $FTP_SERVER || exit 1;"
        LFTP_CMD="$LFTP_CMD user $FTP_USERNAME $FTP_PASSWORD || exit 1;"
        
        if [ "$DRY_RUN" = "true" ]; then
          echo "ðŸ” DRY RUN - showing what would be uploaded:"
          LFTP_CMD="$LFTP_CMD mirror -R --dry-run --verbose --exclude-glob='.git*' ./ $REMOTE_DIR;"
        else
          echo "ðŸ“¤ Uploading files to $REMOTE_DIR..."
          LFTP_CMD="$LFTP_CMD mirror -R --delete --verbose --exclude-glob='.git*' --exclude-glob='.github*' ./ $REMOTE_DIR;"
        fi
        
        LFTP_CMD="$LFTP_CMD bye;"
        
        if echo "$LFTP_CMD" | lftp; then
          echo "âœ… FTP deployment completed successfully"
        else
          echo "âŒ FTP deployment failed"
          exit 1
        fi

    - name: Deploy via SFTP
      if: ${{ github.event.inputs.deploy_method == 'sftp' }}
      env:
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        REMOTE_DIR: ${{ github.event.inputs.target_directory || secrets.FTP_REMOTE_DIR || '/home/${{ secrets.FTP_USERNAME }}/public_html' }}
        SFTP_PORT: ${{ secrets.SFTP_PORT || '22' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "ðŸš€ Deploying to SFTP server: $FTP_SERVER"
        echo "ðŸ“ Target directory: $REMOTE_DIR"
        
        # Build lftp command for SFTP
        LFTP_CMD="set sftp:connect-program 'ssh -i ~/.ssh/deploy_key -p $SFTP_PORT';"
        LFTP_CMD="$LFTP_CMD open sftp://$FTP_USERNAME@$FTP_SERVER;"
        
        if [ "$DRY_RUN" = "true" ]; then
          echo "ðŸ” DRY RUN - showing what would be uploaded:"
          LFTP_CMD="$LFTP_CMD mirror -R --dry-run --verbose ./ $REMOTE_DIR;"
        else
          echo "ðŸ“¤ Uploading files..."
          LFTP_CMD="$LFTP_CMD mirror -R --delete --verbose --exclude-glob='.git*' ./ $REMOTE_DIR;"
        fi
        
        LFTP_CMD="$LFTP_CMD bye;"
        
        echo "$LFTP_CMD" | lftp
        echo "âœ… SFTP deployment completed"

    - name: Deploy via rsync over SSH
      if: ${{ github.event.inputs.deploy_method == 'rsync-ssh' }}
      env:
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        REMOTE_DIR: ${{ github.event.inputs.target_directory || secrets.FTP_REMOTE_DIR || '/home/${{ secrets.FTP_USERNAME }}/public_html' }}
        SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "ðŸš€ Deploying via rsync+SSH to: $FTP_SERVER"
        echo "ðŸ“ Target directory: $REMOTE_DIR"
        
        RSYNC_OPTS="-avz --delete --exclude='.git*'"
        
        if [ "$DRY_RUN" = "true" ]; then
          echo "ðŸ” DRY RUN - showing what would be synced:"
          RSYNC_OPTS="$RSYNC_OPTS --dry-run"
        else
          echo "ðŸ“¤ Syncing files..."
        fi
        
        rsync $RSYNC_OPTS -e "ssh -i ~/.ssh/deploy_key -p $SSH_PORT -o StrictHostKeyChecking=no" \
          ./ $FTP_USERNAME@$FTP_SERVER:$REMOTE_DIR/
        echo "âœ… rsync deployment completed"

    - name: Deployment summary
      if: always()
      env:
        FTP_SERVER: ${{ secrets.FTP_SERVER }}
        DEPLOY_METHOD: ${{ github.event.inputs.deploy_method || 'ftp' }}
        TARGET_DIR: ${{ github.event.inputs.target_directory || secrets.FTP_REMOTE_DIR || 'default' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "## ðŸ“‹ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** ${FTP_SERVER:-'[Not configured]'}" >> $GITHUB_STEP_SUMMARY
        echo "- **Method:** $DEPLOY_METHOD" >> $GITHUB_STEP_SUMMARY
        echo "- **Directory:** $TARGET_DIR" >> $GITHUB_STEP_SUMMARY  
        echo "- **Dry Run:** $DRY_RUN" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ’¡ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "$DRY_RUN" = "true" ]; then
          echo "- Review the dry-run output above" >> $GITHUB_STEP_SUMMARY
          echo "- If satisfied, run again without dry-run to deploy" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Check your website to verify the deployment" >> $GITHUB_STEP_SUMMARY
          echo "- Your IG should now be accessible at your server" >> $GITHUB_STEP_SUMMARY
        fi
